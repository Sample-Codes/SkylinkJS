<html lang="en">
<head>
  <title>Stream : Audio & Video Call</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- Configure for testing hash authentication -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/hmac-sha1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/enc-base64.js"></script>

  <!-- Configure for hosting from repository -->
  <script src="../../../publish/skylink.complete.js"></script>
  <script src="../../config.js"></script>

  <!-- Configure for hosting individually:
    <script src="https://cdn.temasys.io/skylink/skylinkjs/0.6.x/skylink.complete.js"></script>
    <script>
      var config = {
        appKey: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx',
        defaultRoom: 'audio-video'
      };
    </script>
  -->

  <style>

    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }

    #header {
      font-size: 16px;
    }

    #header #btn-group button,
    #peers .peer .peer-info {
      font-size: 14px;
      
    }

    #header {
      background: #f8f8f8;
      border-bottom: solid 1px #ccc;
      padding: 17px 25px 12px;
    }

    #header .red {
      color: red;
    }

    #header .blue {
      color: blue;
    }

    #header #btn-group {
      display: inline-block;
      vertical-align: top;
      margin: -5px 0 0 35px;
    }

    #header #btn-group button {
      background: #ccc;
      margin-left: 5px;
      padding: 5px 12px;
      cursor: pointer;
      transition: background .1s ease-in-out;
      -webkit-transition: background .1s ease-in-out;
      -moz-transition: background .1s ease-in-out;
    }

    #header #btn-group button:hover {
      background: #aaa;
    }

    #header #btn-group button[disabled] {
      background: #ccc!important;
      opacity: .5;
      cursor: initial;
    }

    #header.error {
      color: #d9534f;
      font-weight: 600;
    }

    #peers .peer {
      margin: 15px 15px 0;
      display: inline-block;
      vertical-align: top;
      border: solid 2px blue;
      width: 280px;
    }

    #peers .peer.self {
      border-color: red;
    }

    #peers .peer,
    #peers .peer .peer-video {
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      background: #ccc;
    }

    #peers .peer,
    #peers .peer .peer-info {
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    #peers .peer .peer-video {
      display: block;
      width: 100%;
      height: 200px;
    }

    #peers .peer.active,
    #peers .peer.active .peer-video {
      background: #000;
    }

    #peers .peer .peer-info {
      padding: 10px 13px;
      background: #f8f8f8;
      color: #686868;
    }

    #peers .peer .peer-info p {
      margin: 0;
      line-height: 25px;
    }

    #peers .peer .peer-info p b {
      display: inline-block;
      vertical-align: middle;
      width: 58px;
    }

  </style>
</head>
<body>
  <div id="header">
    You are highlighted in (<b class="red">Red</b>) and other Peers are in (<b class="blue">Blue</b>).

    <div id="btn-group">
      <button onclick="connect({ audio: true, video: true })">Connect with Audio & Video</button>
      <button onclick="connect({ audio: false, video: true })">Connect with Video Only</button>
      <button onclick="connect({ audio: true, video: false })">Connect with Audio Only</button>
      <button onclick="connect({ audio: false, video: false })">Connect with None</button>
    </div>
  </div>

  <div id="peers"></div>

  <script>

    var skylink = new Skylink();

    // Event triggered when Peer has joined the Room.
    skylink.on('peerJoined', function (peerId, peerInfo, isSelf) {
      var element = document.createElement('div');
      element.id = peerId;
      element.className = 'peer' + (isSelf ? ' self' : '');
      element.innerHTML = 
        // Mute <video> element for self Peer only to prevent echo feedback when connected without headphones.
        '<video id="' + peerId + '-video" class="peer-video" autoplay="true"' + (isSelf ? ' muted="true"' : '') + '></video>' +
        '<div class="peer-info">' +
          '<p><b>Peer ID:</b> ' + peerId + '</p>' +
        // `peerInfo.settings.audio` and `peerInfo.settings.video` will appear as `false` because there is no stream present.
          '<p><b>Media:</b> <span id="' + peerId + '-info">None</span></p>' +
        '</div>';

      document.getElementById('peers').appendChild(element);
    });

    // Event triggered when Peer has sent a stream.
    skylink.on('incomingStream', function (peerId, stream, isSelf, peerInfo) {
      if (!document.getElementById(peerId)) {
        return;
      }

      if (peerInfo.settings.audio && peerInfo.settings.video) {
        document.getElementById(peerId + '-info').innerHTML = 'Audio & Video';

      } else if (peerInfo.settings.audio) {
        document.getElementById(peerId + '-info').innerHTML = 'Audio Only';
      
      } else if (peerInfo.settings.video) {
        document.getElementById(peerId + '-info').innerHTML = 'Video Only';
      
      } else {
        document.getElementById(peerId + '-info').innerHTML = 'None';
      }

      document.getElementById(peerId).className += ' active';
      attachMediaStream( document.getElementById(peerId + '-video'), stream );
    });

    // Event triggered when Peer has left the Room.
    skylink.on('peerLeft', function (peerId, peerInfo, isSelf) {
      if (!document.getElementById(peerId)) {
        return;
      }

      document.getElementById('peers').removeChild( document.getElementById(peerId) );
    });


    // Function to connect to Room with stream settings.
    function connect (settings) {
      // Disable buttons from being clickable
      var elements = document.getElementById('btn-group').childNodes;

      for (var i = 0; i < elements.length; i++) {
        if (elements[i].tagName === 'BUTTON') {
          elements[i].disabled = true;
        }
      }

      skylink.init(config, function (initErr) {
        if (initErr) {
          document.getElementById('header').className = 'error';
          document.getElementById('header').innerHTML = 'Failed initialising: ' + (initErr.error.message || initErr.error);
          return;
        }

        skylink.joinRoom(settings, function (joinRoomErr) {
          if (joinRoomErr) {
            document.getElementById('header').className = 'error';
            document.getElementById('header').innerHTML = 'Failed connecting to Room: ' + (joinRoomErr.error.message || joinRoomErr.error);
          }
        });
      });
    }

  </script>
</body>
</html>