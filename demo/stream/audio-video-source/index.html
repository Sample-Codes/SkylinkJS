<html lang="en">
<head>
  <title>Stream : Switching and Selecting Audio & Video Source</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- Configure for styling for demo purposes -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" rel="stylesheet"> 
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.5/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
  <style>
    .video {
      background: #ccc;
    }

    .video.active {
      background: #000;
    }

    .btn {
      cursor: pointer;
    }

    .btn[disabled] {
      cursor: initial!important;
    }

    .modal .modal-dialog .modal-content .modal-body {
      padding-bottom: 25px;
    }

    .modal .modal-dialog .modal-content .modal-body .video-wrapper {
      margin-bottom: 15px;
    }

    .modal .modal-dialog .modal-content .modal-body .video-wrapper,
    .modal .modal-dialog .modal-content .modal-body .video-wrapper .video {
      position: relative;
      z-index: 1;
      width: 468px;
      height: 250px;
    }

    .modal .modal-dialog .modal-content .modal-body .video-wrapper .video-cover {
      position: absolute;
      z-index: 2;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      font-weight: 600;
      text-align: center;
      padding: 105px 15px;
      color: #888;
    }

    .modal .modal-dialog .modal-content .modal-body .input-group-addon,
    .modal .modal-dialog .modal-content .modal-body .input-group .form-control {
      border-radius: 0;
    }

    .modal .modal-dialog .modal-content .modal-body .input-group-addon {
      width: 120px;
      font-size: 14px;
      font-weight: 600;
      border: 0;
      background: 0;
      padding-left: 2px;
    }

    .modal .modal-dialog .modal-content .modal-body .input-group .form-control {
      border: 0;
    }

    #selector .modal-dialog .modal-content .modal-header .close {
      display: none;
    }

    #selector[state="connected"] .modal-dialog .modal-content .modal-header .close {
      display: inline-block;
    }

    #selector[state="error"] .modal-dialog .modal-content {
      color: #dc3545!important;
    }

    #selector[state="error"] .modal-dialog .modal-content .modal-footer {
      display: none;
    }
  </style>

  <!-- Configure for testing hash authentication -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/hmac-sha1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/enc-base64.js"></script>

  <!-- Configure for promise polyfill for IE to enumerateDevices() -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.min.js"></script>

  <!-- Configure for hosting from repository -->
  <script src="../../../publish/skylink.complete.js"></script>
  <script src="../../config.js"></script>

  <!-- Configure for hosting individually:
    <script src="https://cdn.temasys.io/skylink/skylinkjs/0.6.x/skylink.complete.js"></script>
    <script>
      var config = {
        appKey: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx',
        defaultRoom: 'audio-video'
      };
    </script>
  -->
</head>
<body>
  <div id="peers" class="container card-deck"></div>

  <div id="selector" state="" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="selector-title" aria-hidden="true">
    <div class="modal-dialog" role="document">

      <div class="modal-content">
        <div class="modal-header">
          <h5 id="selector-title" class="modal-title">Select Audio & Video Source to Join Call</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div id="selector-content" class="modal-body">
          <div class="video-wrapper">
            <video id="selector-stream" class="video" autoplay="true"></video>
            <div class="video-cover">No Media</div>
          </div>
          <div class="input-group">
            <span id="audio-input-title" class="input-group-addon">Microphone:</span>
            <select id="audio-input"  class="form-control" aria-describedby="audio-input-title">
              <option value="false">None</option>
            </select>
          </div>
          <div class="input-group">
            <span id="video-input-title" class="input-group-addon">Camera:</span>
            <select id="video-input"  class="form-control" aria-describedby="video-input-title">
              <option value="false">None</option>
            </select>
          </div>
          <div class="input-group">
            <span id="audio-output-title" class="input-group-addon">Speaker:</span>
            <select id="audio-output"  class="form-control" aria-describedby="audio-output-title" disabled>
              <option value="null">Default</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button id="selector-preview" type="button" class="btn btn-outline-primary">Get Stream First</button>
          <button id="selector-connect" type="button" class="btn btn-primary" disabled="true">Then Connect</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    var skylink = new Skylink();
    var pendingStream = null;
    var connected = false;

    $('#selector').on('hide.bs.modal', function () {
      attachMediaStream( document.getElementById('selector-stream'), null );
    });

    $('#selector').on('hidden.bs.modal', function () {
      if (!connected) {
        $('#selector').modal('show');
      }
    });

    $('#selector').modal('show');

    if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
      if (document.getElementById('selector-stream') && document.getElementById('selector-stream').setSinkId) {
        document.getElementById('audio-output').disabled = false;
        document.getElementById('audio-output').innerHTML = '';
      }

      navigator.mediaDevices.enumerateDevices().then(function (sources) {
        sources.forEach(function (sourceItem, index) {
          var elementId = null;

          if (['audio', 'audioinput'].indexOf(sourceItem.kind) > -1) {
            elementId = 'audio-input';

          } else if (['video', 'videoinput'].indexOf(sourceItem.kind) > -1) {
            elementId = 'video-input';

          } else if (['audiooutput'].indexOf(sourceItem.kind) > -1) {
            elementId = 'audio-output';
          }

          if (elementId && !document.getElementById(elementId).disabled) {
            var option = document.createElement('option');
            option.value = JSON.stringify({
              deviceId: sourceItem.deviceId || sourceItem.sourceId || sourceItem.id
            });
            option.innerHTML = sourceItem.label || sourceItem.kind + '_' + index;

            document.getElementById(elementId).appendChild(option);
          }
        });
      });
    }

    document.getElementById('selector-preview').onclick = function () {
      var audioInputDevice = JSON.parse( document.getElementById('audio-input').value );
      var audioOutputDevice = JSON.parse( document.getElementById('video-input').value );
      var videoInputDevice = JSON.parse( document.getElementById('audio-output').value );

      if (!audioInputDevice && !videoInputDevice) {
        return;
      }

      navigator.getUserMedia({
        audio: audioInputDevice,
        video: videoInputDevice

      }, function (stream) {
        pendingStream = stream;
        attachMediaStream( document.getElementById('selector-stream'), stream );

      }, function (error) {});
    };

    /*var skylink = new Skylink();
    var streams = {
      preview: null,
      current: null
    };

    // Event triggered when Peer has joined the Room.
    skylink.on('peerJoined', function (peerId, peerInfo, isSelf) {
      var element = document.createElement('div');
      element.id = peerId;
      element.className = 'peer' + (isSelf ? ' self' : '');
      element.innerHTML =
        '<video id="' + peerId + '-video" class="peer-video"></video>' +
        '<div class="peer-info">' +
          '<p><b>Peer ID' + (isSelf ? ' (self)' : '') + ':</b> <span>' + peerId + '</span></p>' +
        // `peerInfo.settings.audio` and `peerInfo.settings.video` will appear as `false` because there is no stream present.
          '<p><b>Media:</b> <span id="' + peerId + '-info">None</span></p>'
        '</div>';

      document.getElementById('peers').appendChild(element);
      renderAudioOutput();
    });

    // Event triggered when Peer has sent a stream.
    skylink.on('incomingStream', function (peerId, stream, isSelf, peerInfo) {
      if (!document.getElementById(peerId)) {
        return;
      }

      if (peerInfo.settings.audio && peerInfo.settings.video) {
        document.getElementById(peerId + '-info').innerHTML = 'Audio & Video';

      } else if (peerInfo.settings.audio) {
        document.getElementById(peerId + '-info').innerHTML = 'Audio Only';
      
      } else if (peerInfo.settings.video) {
        document.getElementById(peerId + '-info').innerHTML = 'Video Only';
      
      } else {
        document.getElementById(peerId + '-info').innerHTML = 'None';
      }

      document.getElementById(peerId + '-video').className = 'peer-video active';
      attachMediaStream( document.getElementById(peerId + '-video'), stream );
    });

    // Event triggered when Peer stream has changed.
    skylink.on('streamEnded', function (peerId) {
      document.getElementById(peerId + '-info').innerHTML = 'None';
      document.getElementById(peerId + '-video').className = 'peer-video';
    });

    // Event triggered when Peer has left the Room.
    skylink.on('peerLeft', function (peerId, peerInfo, isSelf) {
      if (!document.getElementById(peerId)) {
        return;
      }

      document.getElementById('peers').removeChild( document.getElementById(peerId) );
    });


    // Function that gets the preview Stream media and sends it when self Peer chooses to.
    function preview () {
      var settings = {
        audio: JSON.parse( document.getElementById('audio-input').value ),
        video: JSON.parse( document.getElementById('video-input').value )
      };

      // Prevent from double-clicks.
      document.getElementById('btn-preview').disabled = true;
      document.getElementById('btn-send').disabled = true;
      document.getElementById('error').innerHTML = '';

      // Stop existing previewed stream.
      if (streams.preview) {
        try {
          streams.preview.getTracks().forEach(function (track) {
            track.stop();
          });
        } catch (error) {
          streams.preview.stop();
        }
      }

      if (settings.audio || settings.video) {
        navigator.getUserMedia(settings, function (stream) {
          streams.preview = stream;

          document.getElementById('btn-preview').disabled = false;
          document.getElementById('btn-send').disabled = false;
          document.getElementById('preview').className = 'active';

          attachMediaStream( document.getElementById('preview-video'), stream );

        }, function (error) {
          document.getElementById('btn-preview').disabled = false;
          document.getElementById('error').innerHTML = 'Failed retrieving stream: ' + error.message;
        });

      } else {
        document.getElementById('btn-preview').disabled = false;
        document.getElementById('btn-send').disabled = false;
        document.getElementById('preview').className = '';

        attachMediaStream( document.getElementById('preview-video'), null );
      }
    }

    
    // Function that sends the currently previewed Stream.
    function send () {
      // Set with the Stream we are about to send.
      streams.current = streams.preview;
      streams.preview = null;

      // Prevent from double-clicks.
      document.getElementById('btn-preview').disabled = true;
      document.getElementById('btn-send').disabled = true;
      document.getElementById('error').innerHTML = '';

      // Stop the current sending stream and start sending the new stream.
      skylink.stopStream();

      var refreshCallback = function () {
        // Start connecting to the Room if user is not in the Room.
        if (Object.keys(skylink.getPeersInRoom()).length === 0) {
          skylink.init(config, function (initErr) {
            if (initErr) {
              document.getElementById('btn-preview').disabled = false;
              document.getElementById('btn-send').disabled = false;
              document.getElementById('error').innerHTML = 'Failed initialising: ' + (initErr.error.message || initErr.error);
              return;
            }

            skylink.joinRoom(function (joinRoomErr) {
              document.getElementById('btn-preview').disabled = false;

              if (joinRoomErr) {
                document.getElementById('btn-send').disabled = false;
                document.getElementById('error').innerHTML = 'Failed connecting to Room: ' + (joinRoomErr.error.message || joinRoomErr.error);
                return;
              }

              document.getElementById('btn-send').disabled = true;
              document.getElementById('btn-send').innerHTML = 'Replace';
            });
          });
        } else {
          document.getElementById('btn-preview').disabled = false;
          document.getElementById('btn-send').disabled = true;    
        }
      };

      if (streams.current) {
        skylink.sendStream(streams.current, refreshCallback);

      } else {
        skylink.refreshConnection(refreshCallback);
      }
    }

    // Function that renders the selected audio output sink ID.
    // Returns [Boolean] if `setSinkId()` is supported or not.
    function renderAudioOutput () {
      if (typeof document.getElementById('preview-video').setSinkId !== 'function') {
        return;
      }

      Object.keys( skylink.getPeersInRoom() ).forEach(function (peerId) {
        document.getElementById(peerId + '-video').setSinkId( document.getElementById('audio-output').value || 'default' );
      });

      document.getElementById('preview-video').setSinkId( document.getElementById('audio-output').value || 'default' );
      return true;
    }


    // Retrieve the list of audio input, output and video input sources.
    skylink.getStreamSources(function (sources) {
      Object.keys(sources).forEach(function (trackType) {
        sources[trackType].input.forEach(function (item) {
          var option = document.createElement('option');
          option.value = JSON.stringify({ deviceId: item.deviceId });
          option.innerHTML = item.label;

          document.getElementById(trackType + '-input').appendChild(option);
        });
      });

      // Render the list of audio output sources only if .setSinkId() is supported!
      if (renderAudioOutput()) {
        document.getElementById('audio-output').innerHTML = '';

        sources.audio.output.forEach(function (item) {
          var option = document.createElement('option');
          option.value = item.deviceId;
          option.innerHTML = item.label;

          document.getElementById('audio-output').appendChild(option);
        });

        // Start rendering the correct audio output speaker if selection has switched.
        document.getElementById('audio-output').disabled = false;
        document.getElementById('audio-output').onchange = function () {
          renderAudioOutput();
        };
      }
    });*/
  </script>

</body>
</html>
